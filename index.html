<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í…Œë§ˆ íƒ€ì´ë¨¸ ëª¨ë‹ˆí„°</title>
  <style>
    /* ... (ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤) ... */
    :root {
      --bg: #f9fafb;
      --fg: #111827;
      --primary: #2563eb;
      --danger: #dc2626;
      font-family: Arial, "Pretendard", sans-serif;
    }
    body{background:var(--bg);color:var(--fg);margin:0;padding:1rem;}
    h1{font-size:1.75rem;text-align:center;margin-bottom:1rem;}
    .tabs{display:flex;justify-content:center;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;}
    .tabs button,.tabs input{font-size:0.9rem;}
    .section{background:#fff;padding:1rem;border-radius:0.75rem;margin-bottom:1rem;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
    button{padding:0.5rem 0.8rem;margin:0.2rem;font-size:1rem;border:none;border-radius:0.5rem;background:var(--primary);color:#fff;cursor:pointer;}
    button.danger{background:var(--danger);}
    button.small{font-size:0.75rem;padding:0.3rem 0.5rem;}
    input{padding:0.5rem;font-size:1rem;border:1px solid #d1d5db;border-radius:0.4rem;}
    .timer-controls{display:flex;flex-wrap:wrap;gap:0.25rem;margin-top:0.3rem;}
    #themeList{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;}
    .theme-card{border:1px solid #e5e7eb;border-radius:0.75rem;padding:1rem;background:white;display:flex;flex-direction:column;gap:0.3rem;}
    .theme-row{display:flex;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;}
    .label{font-weight:bold;}
    #themeForm{display:none;text-align:center;margin-bottom:1rem;}
    #themeForm.show{display:block;}
  </style>
</head>
<body>

<h1>í…Œë§ˆ íƒ€ì´ë¨¸ ëª¨ë‹ˆí„°</h1>
<div class="tabs">
  <button onclick="toggleForm()">í…Œë§ˆ ë“±ë¡ ì—´ê¸°/ë‹«ê¸°</button>
  <button onclick="reload()">ì„œë²„ê°’ ìƒˆë¡œê³ ì¹¨</button>
</div>
<div id="themeForm">
  <input id="inpCode" placeholder="ì½”ë“œ ì…ë ¥" />
  <button onclick="addTheme()">ë“±ë¡</button>
  <div><span id="msg" style="color:var(--danger); font-weight:bold;"></span></div>
</div>

<div class="section" id="themeList"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì „ì—­ ìƒìˆ˜/ë³€ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const GAS_URL         = "https://script.google.com/macros/s/AKfycbzoxH5bvqq5wjLOq-59r1Uc3J3wAuuycUExe9n6ynoPYkFAXkt_IUws3lfVFliOxr44/exec";
const STORAGE_KEY     = "themes";
const RESET_STORE_KEY = "staffResetDurations";

let themes            = JSON.parse(localStorage.getItem(STORAGE_KEY)     || "[]");
let staffResetDur     = JSON.parse(localStorage.getItem(RESET_STORE_KEY) || "{}");

let timers            = {};
let staffTimers       = {};
let staffRunning      = {};
let staffPausedRemain = {};
let staffIsReset      = {};

let audioCtx;
let isAlarming = false; // ğŸ”” ì•ŒëŒì´ ìš¸ë¦¬ê³  ìˆëŠ”ì§€ ì—¬ë¶€

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì˜¤ë””ì˜¤ ìœ í‹¸ ğŸ”” (ìˆ˜ì •ëœ ì„¹ì…˜)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
function initAudio() {
  if (!audioCtx) {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    } catch (e) {
      console.error("Audio context could not be created:", e);
    }
  }
}

// ì•Œë¦¼ìŒ ì¬ìƒ í•¨ìˆ˜ (ğŸ”” ë¡œì§ ì „ì²´ ë³€ê²½)
function playAlertSound() {
  // ğŸ”” ì´ë¯¸ ì•ŒëŒì´ ìš¸ë¦¬ê³  ìˆê±°ë‚˜, AudioContext ì‚¬ìš© ë¶ˆê°€ ì‹œ ì¤‘ë‹¨
  if (isAlarming || (!window.AudioContext && !window.webkitAudioContext)) return; 
  initAudio();
  if (!audioCtx) return;

  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
  
  isAlarming = true; // ğŸ”” ì•ŒëŒ ì‹œì‘ (ì¤‘ë³µ ë°©ì§€)
  
  try {
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    oscillator.type = 'triangle'; // 'sine', 'square', 'sawtooth', 'triangle'
    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5 (ë†’ì€ 'ì‚')

    const now = audioCtx.currentTime;
    const beepDuration = 0.1;   // ğŸ”” 0.1ì´ˆ "ë "
    const beepInterval = 0.25;  // ğŸ”” 0.25ì´ˆ ê°„ê²© (0.1ì´ˆ ìš¸ë¦¬ê³  0.15ì´ˆ ì‰¼)
    const alarmDuration = 10.0; // ğŸ”” 10ì´ˆê°„ ìš¸ë¦¼
    
    gainNode.gain.setValueAtTime(0, now); // ğŸ”” ì‹œì‘ì€ ì¡°ìš©íˆ
    oscillator.start(now);

    // ğŸ”” 10ì´ˆ ë™ì•ˆ 0.25ì´ˆ ê°„ê²©ìœ¼ë¡œ 0.1ì´ˆì§œë¦¬ ë¹„í”„ìŒì„ ì˜ˆì•½
    for (let t = 0; t < alarmDuration; t += beepInterval) {
      gainNode.gain.setValueAtTime(0.3, now + t); // ğŸ”” 0.3 ë³¼ë¥¨ìœ¼ë¡œ ì¼œê¸°
      gainNode.gain.setValueAtTime(0,   now + t + beepDuration); // ğŸ”” 0.1ì´ˆ ë’¤ ë„ê¸°
    }
    
    // ğŸ”” 10ì´ˆ ë’¤ì— ì˜¤ì‹¤ë ˆì´í„° ì™„ì „ ì •ì§€
    oscillator.stop(now + alarmDuration);
    
    // ğŸ”” 10ì´ˆ ë’¤ì— ì•ŒëŒ ìƒíƒœ í•´ì œ (ë‹¤ì‹œ ìš¸ë¦´ ìˆ˜ ìˆê²Œ)
    setTimeout(() => {
      isAlarming = false;
    }, alarmDuration * 1000);

  } catch (e) {
    console.error("Audio playback failed:", e);
    isAlarming = false; // ğŸ”” ì—ëŸ¬ ë‚˜ë„ ìƒíƒœ í•´ì œ
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìœ í‹¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// ... (secToHMS ë“± ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤) ...
const $list = document.getElementById("themeList");
const saveThemes = () => localStorage.setItem(STORAGE_KEY,     JSON.stringify(themes));
const saveResets = () => localStorage.setItem(RESET_STORE_KEY, JSON.stringify(staffResetDur));

const secToHMS = s=>{
  if(s<=0||!Number.isFinite(s)) return "00:00:00";
  const h = String(Math.floor(s/3600)).padStart(2,"0");
  const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss= String(s%60).padStart(2,"0");
  return `${h}:${m}:${ss}`;
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UI ì œì–´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleForm(){ 
  initAudio(); // ğŸ””
  document.getElementById("themeForm").classList.toggle("show"); 
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì„œë²„ fetch
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchThemeData(code){
  return await (await fetch(`${GAS_URL}?order=gettimer&id=${encodeURIComponent(code)}`)).json();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   í…Œë§ˆ ì¹´ë“œ ë Œë”ë§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderThemeRow(theme){
  const div=document.createElement("div");
  div.className="theme-card";
  const hintDisplay=theme.hint===999?"0":theme.hint;
  div.innerHTML=`
    <div class="theme-row"><span class="label">ì´ë¦„:</span> ${theme.name||"-"}</div>
    <div class="theme-row"><span class="label">ì½”ë“œ:</span> ${theme.code}</div>
    <div class="theme-row"><span class="label">ë‚¨ì€ì‹œê°„:</span> <span id="remain_${theme.code}">ê³„ì‚°ì¤‘â€¦</span></div>
    <div class="theme-row"><span class="label">íŒíŠ¸ ê°œìˆ˜:</span> ${hintDisplay}</div>

    <div class="theme-row">
      <div>
        <span class="label">ì§ì› íƒ€ì´ë¨¸:</span> <span id="staffTimer_${theme.code}">00:00:00</span>
        <div class="timer-controls">
          <button class="small" onclick="changeStaffTime('${theme.code}', -300)">-5ë¶„</button>
          <button class="small" onclick="changeStaffTime('${theme.code}', -60)">-1ë¶„</button>
          <button class="small" onclick="toggleStaffTimer('${theme.code}')">ì¬ê°œ/ì •ì§€</button>
          <button class="small" onclick="changeStaffTime('${theme.code}',  60)">+1ë¶„</button>
          <button class="small" onclick="changeStaffTime('${theme.code}', 300)">+5ë¶„</button>
        </div>
      </div>
      <button class="danger small" onclick="resetStaffTimer('${theme.code}')">ë¦¬ì…‹</button>
    </div>
  `;
  $list.appendChild(div);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì²˜ìŒ/ì„œë²„ ìƒˆë¡œê³ ì¹¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function reload(){
  initAudio(); // ğŸ”” ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™” ì‹œë„
  $list.innerHTML="";
  await Promise.all(themes.map(async theme=>{
    renderThemeRow(theme);
    try{
      const data=await fetchThemeData(theme.code);
      if(data && data.state){
        theme.name         = data.themname || "-";
        theme.hint         = data.hint ?? 0;
        timers[theme.code] = Number(data.timer);
      }
    }catch(e){console.error(e);}

    if(staffResetDur[theme.code]==null){   // ê¸°ë³¸ 1h ì„¤ì •
      staffResetDur[theme.code]=3600;
      saveResets();
    }
    staffIsReset[theme.code]=false;        // â˜… ì´ˆê¸°ê°’
  }));
  saveThemes();
}
document.addEventListener("DOMContentLoaded",reload);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì£¼ê¸°ì  í™”ë©´ ì—…ë°ì´íŠ¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateTimers(){
  const now=Math.floor(Date.now()/1000);
  for(const theme of themes){
    /* ë©”ì¸ íƒ€ì´ë¨¸ */
    const mainExpiry = timers[theme.code]; // ğŸ”” ë§Œë£Œ ì‹œê°
    const mainRemain = mainExpiry ? mainExpiry - now : 0;
    const elMain=document.getElementById(`remain_${theme.code}`);
    if(elMain) elMain.textContent=secToHMS(mainRemain);
    
    // ğŸ”” ë©”ì¸ íƒ€ì´ë¨¸ê°€ ì •í™•íˆ 0ì´ˆê°€ ë˜ì—ˆì„ ë•Œ
    if(mainExpiry && mainExpiry === now){
      playAlertSound();
    }

    /* ìŠ¤íƒœí”„ íƒ€ì´ë¨¸ */
    const elStaff=document.getElementById(`staffTimer_${theme.code}`);
    if(!elStaff) continue;

    let left;
    if(staffRunning[theme.code]){
      left=(staffTimers[theme.code]??now)-now;
      if(left<=0){ 
        staffRunning[theme.code]=false; 
        left=0; 
        playAlertSound(); // ğŸ”” ìŠ¤íƒœí”„ íƒ€ì´ë¨¸ê°€ 0ì´ˆê°€ ë˜ì—ˆì„ ë•Œ
      }
      staffPausedRemain[theme.code]=left;
    }else{
      left=staffPausedRemain[theme.code]??staffResetDur[theme.code]??3600;
    }
    elStaff.textContent=secToHMS(left);
  }
}
setInterval(updateTimers,1000);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìŠ¤íƒœí”„ íƒ€ì´ë¨¸ ì»¨íŠ¸ë¡¤
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// ... (ì´ ì•„ë˜ì˜ ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ë“¤ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤) ...
function toggleStaffTimer(code){
  initAudio(); // ğŸ””
  const now=Math.floor(Date.now()/1000);
  if(staffRunning[code]){                     /* â–¶ ì¼ì‹œì •ì§€ */
    const remain=(staffTimers[code]??now)-now;
    staffPausedRemain[code]=Math.max(0,remain);
    staffRunning[code]=false;
    staffIsReset[code]=false;                 // â˜… ë‹¨ìˆœ ì •ì§€
  }else{                                      /* â–  ì¬ê°œ */
    const remain=Math.max(0,staffPausedRemain[code]??staffResetDur[code]??3600);
    staffTimers[code]=now+remain;
    staffRunning[code]=true;
    staffIsReset[code]=false;                 // â˜… ë¦¬ì…‹ ëª¨ë“œ í•´ì œ
  }
}

function changeStaffTime(code,delta){
  initAudio(); // ğŸ””
  if(staffRunning[code]){                     /* ë™ì‘ ì¤‘ â†’ ë§Œë£Œ ì‹œê° ì¡°ì • */
    staffTimers[code]=(staffTimers[code]??Math.floor(Date.now()/1000))+delta;
  }else{                                      /* ì •ì§€ ë˜ëŠ” ë¦¬ì…‹ ëª¨ë“œ */
    const base=staffPausedRemain[code]??staffResetDur[code]??3600;
    let newRemain=Math.max(0,base+delta);
    staffPausedRemain[code]=newRemain;

    if(staffIsReset[code]){                   // â˜… â€œë¦¬ì…‹ ëª¨ë“œâ€ì—ì„œë§Œ ì €ì¥
      staffResetDur[code]=newRemain;
      saveResets();
    }
  }
}

function resetStaffTimer(code){
  initAudio(); // ğŸ””
  const defaultSec=staffResetDur[code]??3600;
  staffPausedRemain[code]=defaultSec;
  staffRunning[code]=false;
  staffIsReset[code]=true;                    // â˜…
  delete staffTimers[code];

  const el=document.getElementById(`staffTimer_${code}`);
  if(el) el.textContent=secToHMS(defaultSec);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   í…Œë§ˆ ì¶”ê°€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function addTheme(){
  initAudio(); // ğŸ””
  const code=document.getElementById("inpCode").value.trim();
  const msg =document.getElementById("msg");
  if(!code) return msg.textContent="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”";
  if(themes.some(t=>t.code===code)) return msg.textContent="ì´ë¯¸ ë“±ë¡ë¨";

  themes.push({code,name:"-",hint:0});
  staffResetDur[code]=3600;
  staffIsReset[code]=false;
  saveThemes(); saveResets();
  reload();
  document.getElementById("inpCode").value="";
  msg.textContent="";
}
</script>

</body>
</html>